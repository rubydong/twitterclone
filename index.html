<!DOCTYPE html>
<html>
    <head>
        
        <link rel="stylesheet" type="text/css" href="materialize/css/materialize.css">
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <style>
            #tweetButton {
                margin-top: 10px;
                border:1px solid #D4D4D4; 
                border-radius: 5px; 
                background-color: #FFF;
                color: #798AA8 !important;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            #tweetButton:hover {
                color: #999EA8 !important;
                background-color: #FFF !important;
            }
        </style>
    </head>
    
    <body>
        <div class="navigation">
            <a href="/logout" id="logoutLink">LOGOUT</a>
            <a href="/follow">FOLLOW</a>
            <a href="/search">SEARCH</a>
            <a href="" id="profileClick">PROFILE</a>
            <a href="/">HOME</a>
            <a href="/" style="float: left;">TWITTER</a>
        </div> 
        
        
        <div class="everything">
        
            <div id="userInfo">

                <img src="img/cat.jpg" width="50px"> <br>
                <div class="info"></div>
            </div>

            <div id="tweetsInfo">
                
                <form method="POST" action="/additem" id="additemForm">
                    <p><p>
                    <div class="formContent">
                    <textarea name="content" id="content"></textarea> <br>
                        <span style="text-transform: uppercase;font-size: 11px;">
                            TOTAL WORD COUNT: <span id="count">0</span> 
                         <br>
                    <button type="submit" id="tweetButton">Tweet</button>   
                            </span>
                    </div>
                </form>

                <div id="newsfeed"></div>
            </div>

        </div>
        <script>

            $(document).ready(function () {
                
                
                $.ajax ({
                    "url": "/search",
                    "type": "POST"
                }).done(function (data) {
                    if (data.status == "OK") {
                        var tweetsArr = data.items;
                        for (var i = 0; i < tweetsArr.length; i++) {
                            var timestamp = tweetsArr[i].timestamp;
                            var date = new Date (timestamp);
                            var date = (date.getMonth()+1) + "/" +  date.getDate() + "/" + date.getFullYear();
                            
                            $("#newsfeed").prepend("<div class='tweet'> <img src='' align='left'> <div class='tweetsubinfo'>@" + tweetsArr[i].username + " Id #" + tweetsArr[i].id + "   " + date + "</div>" + tweetsArr[i].content + "</div>");
                        }
                    } else {
                        window.location = "/login";
                    }
                });
                
                $.ajax ({
                    "url": "/user", 
                    "type": "POST"
                }).done(function (data) {
                    if (data.status == "OK") {
                        
                        var followers = "<a href='/followers/" + data.user.username + "'> Followers </a>";
                        var following = "<a href='/following/" + data.user.username + "'> Following </a>";
                        
                        $(".info").append("@" + data.user.username + "<br>" + "Email: " +data.user.email + "<br>"  + data.user.followers + " " + followers + "<br>" + data.user.following + " " + following); 
                        document.getElementById('profileClick').setAttribute('href',"/profile/" + data.user.username);
                    } else {
                         //alert(JSON.stringify(data.error));
                    }
                });
                
                $("#logoutLink").click(function(event) {
                    $.ajax ({
                        "url": "/logout",
                        "type": "GET"
                    });
                });
                
                 $("#additemForm").submit(function (event) {
                    event.preventDefault(); 
                    $.ajax({
                        "url": "/additem",
                        "type":"POST",
                        "data": JSON.stringify({
                            content: $("textarea[name='content'").val()
                        }), 
                        "dataType": "json", 
                        "contentType": "application/json; charset=utf-8"
                    }).done(function(data){
                        if (data.status == "OK") {
                            $("#content").val("");
                            //alert(data.id);
                            $.ajax({
                                "url": "/item",
                                "type": "POST",
                                "data": JSON.stringify({
                                    itemId: data.id
                                }), 
                                "dataType": "json", 
                                "contentType": "application/json; charset=utf-8"
                            }).done(function(d) {
                                if (d.status == "OK") {
                                    var timestamp = d.item.timestamp;
                                    var date = new Date (timestamp);
                                    var date = (date.getMonth()+1) + "/" +  date.getDate() + "/" + date.getFullYear();

                                    $("#newsfeed").prepend("<div class='tweet'> <img src='' align='left'>@" + d.item.username + " Id #" + d.item.id + "   " + date + "</div>" + d.item.content + "</div>");
                                }
                            });                         
                        }
                        else {
                            $("#newsfeed").prepend("<p> <center>" + data.error);
                        }
                    });
                });
                
                $("#content").on('keyup', function() {
                    var wordcount = this.value.length;
                    $("#count").html(wordcount);
                });     
                
            });
    
        </script>
    </body>
</html>

