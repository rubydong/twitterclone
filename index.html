<!DOCTYPE html>
<html>
    <head>
        
        <link rel="stylesheet" type="text/css" href="materialize/css/materialize.css">
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    </head>
    
    <body>
        <div class="navigation">
            <a href="/logout" id="logoutLink">LOGOUT</a>
            <a href="/follow">FOLLOW</a>
            <a href="/search">SEARCH</a>
            <a href="" id="profileClick">PROFILE</a>
            <a href="/">HOME</a>
            <a href="/" style="float: left;">TWITTER</a>
        </div> 
        
        
        <div class="everything" ng-app="myApp" ng-controller="myCtrl" ng-cloak>
        
            <div id="userInfo">

                <img src=""> <br>
                <div class="info">
                    @ {{userinfo.user.username}} <br>
                    {{userinfo.user.email}} <br>
                    {{userinfo.user.followers}} <a href="/followers/{{userinfo.user.username}}">Followers</a> <br>
                    {{userinfo.user.following}} <a href="/following/{{userinfo.user.username}}">Following </a> <br>
                </div>
            </div>

            <div id="tweetsInfo">
                
                <form method="POST" action="/additem" id="additemForm">
                    <p><p>
                    <div class="formContent">
                        <textarea name="content" id="content"></textarea> <br>
                        <span style="text-transform: uppercase;font-size: 11px;">
                            TOTAL WORD COUNT: <span id="count">0</span> 
                        </span><br>
                    
                        <input type="text" name="parent" placeholder="parent id"> <br>
                        <input type="text" name="media" placeholder="[{idname, ...}]"> <br>
                        <button type="submit" id="tweetButton">Tweet</button>   
                    </div>
                </form>

                <div id="newsfeed">
                    <div class="tweet" ng-repeat = "tweet in newsfeed.items |orderBy:'-'">
                        <img src='' align='left'> @{{tweet.username}}
                        Id #{{tweet.id}} 
                        {{tweet.timestamp | date:'M/d/yyyy'}}
                        <a href="" class="delete" id= "{{tweet.id}}"></a>
                        <br>
                        {{tweet.content}} 
                    </div>
                </div>
            </div>

        </div>
        <script>

            var app = angular.module('myApp', []);
            
            app.controller('myCtrl', function($scope, $http) {
                var userInfo = $http.post("/user");
                userInfo.success(function (data) {
                    if (data.status == "OK") {
                        $scope.userinfo = data;
                        document.getElementById('profileClick').setAttribute('href',"/profile/" + data.user.username);
                    } else {
                        window.location = "/login";
                    }
                });
                
                var newsfeed = $http.post("/search", 
                JSON.stringify({following: false}));
                newsfeed.success(function (data) {
                    if (data.status == "OK") {
                        $scope.newsfeed = data;
                    } else {
                        window.location = "/login";
                    }
                });
                
                
                $("#logoutLink").click(function(event) {
                    var logout = $http.get("/logout");
                });
            
                $("#additemForm").submit(function (event) {
                    event.preventDefault(); 
                    var addtweet = $http.post("/additem", JSON.stringify({
                        content: $("textarea[name='content']").val(), 
                        parent: $("input[name='parent']").val(),
                        media: $("input[name='media']").val()
                    }));
                                              
//                                              
//                    var searchResults = $http.post("/search",
//                        JSON.stringify({
//                        timestamp: $("input[name='timestamp']").val(), 
//                        limit: $("input[name='limit']").val(), 
//                        q: $("input[name='q']").val(),
//                        username: $("input[name='username']").val(),
//                        following: $("input[name='following']").val()
//                    }));
//                                              
                                              
                    addtweet.success(function (data) {
                        if (data.status == "OK") {
                            $("#content").val("");
                            var postToNewsfeed = $http.post("/item", JSON.stringify({itemId: data.id}));
                            postToNewsfeed.success(function (d) {
                                if (d.status == "OK") {
                                    var timestamp = d.item.timestamp;
                                    var date = new Date (timestamp);
                                    var date = (date.getMonth()+1) + "/" +  date.getDate() + "/" + date.getFullYear();
                                        
                                    $("#newsfeed").prepend("<div class='tweet'> <img src='' align='left'> <div class='tweetsubinfo'>@" + d.item.username + " Id #" + d.item.id + "   " + date + "</div>" + d.item.content + "</div>");
                                } else {
                                    $("#newsfeed").prepend("<p> <center>" + data.error);
                                }
                            });
                        }
                    });
                
                });
                
                $("#content").on('keyup', function() {
                    var wordcount = this.value.length;
                    $("#count").html(wordcount);
                });     
            });


    
        </script>
    </body>
</html>

