<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="../materialize/css/materialize.css">
        <link rel="stylesheet" type="text/css" href="../style.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
        <style>
            
        </style>
    </head>
    <body>

        <div class="navigation">
                <a href="/logout" id="logoutLink">LOGOUT</a>
                <a href="/follow">FOLLOW</a>
                <a href="/search">SEARCH</a>
                <a href="" id="profileClick">PROFILE</a>
                <a href="/">HOME</a>
                <a href="/" style="float: left;">TWITTER</a>
        </div> 
        
        <div class="everything" ng-app="myApp" ng-controller="myCtrl" class="ng-cloak">
            

            <div id="userInfo">
                
                <img src="../img/cat.jpg" width="200px"> <br>
                <div class="info">
                    @ {{whoami.username}} <br>
                    {{userinfo.user.email}} <br>
                    {{userinfo.user.followers}} <a href="/followers/{{whoami.username}}">Followers</a> <br>
                    {{userinfo.user.following}} <a href="/following/{{whoami.username}}">Following </a> <br>
                    
                </div>
            </div>

            <div id="tweetsInfo">
                <div class="tweet" ng-repeat = "tweet in newsfeed.items |orderBy:'-'">
                    <img src='' align='left'> @{{tweet.username}}
                    Id #{{tweet.id}} 
                    {{tweet.timestamp | date:'M/d/yyyy'}}
                    <a href="" class="delete" id= "{{tweet.id}}" ng-click=deleteTweet(tweet.id)>{{deleteButton}}</a>
                    <br>
                    {{tweet.content}} 
                </div>
            </div>
            
        </div>
         
        
        <script>

            var app = angular.module('myApp', []);
            app.controller('myCtrl', function($scope, $http) {
                $scope.deleteTweet = function (id) {
                    var delTweet = $http.delete("/item/" + id);
                    delTweet.success(function(data, status) {
                        location.reload();
                    });
                }
                
                var arr = (window.location.pathname).split("/");
                var username = arr[arr.length-1];
                $scope.profileUser = username;
                
                var whoami = $http.post("/whoami");
                whoami.success(function (data, status) {
                    if (data.status == "OK") {
                        $scope.whoami = data;
                        var newlocation = "window.location='/profile/" + $scope.whoami.username + "'";
                        document.getElementById('profileClick').setAttribute('href',"/profile/" + data.user.username);
                    } else 
                        window.location = "/login";
                });
                
                var userinfo = $http.get("/user/" + username);
                userinfo.success(function (data) {
                    if (data.status == "OK")
                        $scope.userinfo = data;
                        
                    else 
                        $(".everything").html("This profile does not exist.");
                });
                
                 $("#logoutLink").click(function(event) {
                    var logout = $http.get("/logout");
                });
                
                
                
                var newsfeed = $http.post("/search", JSON.stringify({username:username}));
                newsfeed.success(function (data) {
                    if (data.status == "OK") {
                        $scope.newsfeed = data;
//                        alert(JSON.stringify(data));
                        $scope.deleteButton = "";
                        if ($scope.profileUser == $scope.whoami.username)
                            $scope.deleteButton = "delete";
                    } else
                        window.location = "/login";
                });
            
            });

    
        </script>
    </body>
</html>

